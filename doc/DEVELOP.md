# Documentation Development Guide

## Building the docs

```bash
make docs
```

This runs `dune build @doc` and opens `_build/default/_doc/_html/index.html`.

## How it works

Documentation is generated by [odoc](https://ocaml.github.io/odoc/) via Dune's built-in integration. There are two kinds of documentation source:

1. **`.mld` files** — hand-written prose pages (odoc markup format)
2. **`.mli` files** — API reference extracted from module interfaces

Dune's `(documentation ...)` stanzas (in `doc/` and `lib/` subdirectories) tell odoc which `.mld` pages belong to which package. Module API docs are generated automatically for every public module in each library.

## Source file → generated HTML mapping

All generated HTML lives under `_build/default/_doc/_html/`.

### Auto-generated root index

| Generated HTML | Source |
|---|---|
| `index.html` | Auto-generated by odoc — lists all packages |

### `spectrum` package

| Generated HTML | Source |
|---|---|
| `spectrum/index.html` | [doc/index.mld](../doc/index.mld) — overview, usage guide, tag syntax, capabilities |
| `spectrum/Spectrum/index.html` | [lib/spectrum/spectrum.mli](../lib/spectrum/spectrum.mli) — API reference |
| `spectrum/Spectrum/Lexer/index.html` | [lib/spectrum/lexer.mll](../lib/spectrum/lexer.mll) → (ocamllex) → `lexer.ml` — exposed through `spectrum.mli` |
| `spectrum/Spectrum/Parser/index.html` | [lib/spectrum/parser.ml](../lib/spectrum/parser.ml) — exposed through `spectrum.mli` |
| `spectrum/Spectrum/Capabilities/index.html` | Re-exported from `spectrum_capabilities` via `spectrum.mli` |
| `spectrum/Spectrum/{Exn,Noexn,Simple,...}/index.html` | Submodules defined in `spectrum.mli` |

Dune config: [doc/dune](../doc/dune) declares `(mld_files index)` for the `spectrum` package.

### `spectrum_tools` package

| Generated HTML | Source |
|---|---|
| `spectrum_tools/index.html` | [doc/spectrum_tools/index.mld](../doc/spectrum_tools/index.mld) |
| `spectrum_tools/Spectrum_tools/index.html` | [lib/spectrum_tools/spectrum_tools.ml](../lib/spectrum_tools/spectrum_tools.ml) — wrapper module |
| `spectrum_tools/Spectrum_tools/Convert/index.html` | [lib/spectrum_tools/convert.mli](../lib/spectrum_tools/convert.mli) |
| `spectrum_tools/Spectrum_tools/Query/index.html` | [lib/spectrum_tools/query.mli](../lib/spectrum_tools/query.mli) |
| `spectrum_tools/Spectrum_tools/Private/Utils/index.html` | [lib/spectrum_tools/utils.ml](../lib/spectrum_tools/utils.ml) — no `.mli`, docs from `.ml` |

Dune config: [doc/spectrum_tools/dune](../doc/spectrum_tools/dune)

### `spectrum_capabilities` package

| Generated HTML | Source |
|---|---|
| `spectrum_capabilities/index.html` | [doc/spectrum_capabilities/index.mld](../doc/spectrum_capabilities/index.mld) |
| `spectrum_capabilities/Spectrum_capabilities/index.html` | [lib/spectrum_capabilities/spectrum_capabilities.ml](../lib/spectrum_capabilities/spectrum_capabilities.ml) — wrapper module |
| `spectrum_capabilities/Spectrum_capabilities/Capabilities/index.html` | [lib/spectrum_capabilities/capabilities.mli](../lib/spectrum_capabilities/capabilities.mli) |

Dune config: [doc/spectrum_capabilities/dune](../doc/spectrum_capabilities/dune)

### `spectrum_palettes` package

| Generated HTML | Source |
|---|---|
| `spectrum_palettes/index.html` | [doc/spectrum_palettes/index.mld](../doc/spectrum_palettes/index.mld) |
| `spectrum_palettes/basic_palette.html` | **Generated** — see below |
| `spectrum_palettes/xterm256_palette.html` | **Generated** — see below |
| `spectrum_palettes/Spectrum_palettes/Terminal/index.html` | [lib/spectrum_palettes/terminal.ml](../lib/spectrum_palettes/terminal.ml) — contains `Basic` and `Xterm256` submodules |

Dune config: [doc/spectrum_palettes/dune](../doc/spectrum_palettes/dune) declares `(mld_files index basic_palette xterm256_palette)`.

#### Generated palette pages

The `basic_palette.html` and `xterm256_palette.html` pages are generated from JSON via a build-time tool:

```
lib/spectrum_palettes/16-colors.json
  → tools/gen_palette_docs/gen_palette_docs.exe basic
  → basic_palette.mld
  → basic_palette.html

lib/spectrum_palettes/256-colors.json
  → tools/gen_palette_docs/gen_palette_docs.exe xterm256
  → xterm256_palette.mld
  → xterm256_palette.html
```

The tool ([tools/gen_palette_docs/gen_palette_docs.ml](../tools/gen_palette_docs/gen_palette_docs.ml)) reads the JSON palette definitions and outputs odoc markup tables with color codes, tag names, hex values, RGB components, and inline HTML color swatches. This keeps the JSON files as the single source of truth — the same JSON is used by the PPX at compile time and by this tool for documentation.

Dune rules in [doc/spectrum_palettes/dune](../doc/spectrum_palettes/dune) wire this up:

```dune
(rule
 (target basic_palette.mld)
 (deps (:json ../../lib/spectrum_palettes/16-colors.json))
 (action
  (with-stdout-to %{target}
   (run %{exe:../../tools/gen_palette_docs/gen_palette_docs.exe} basic %{json}))))
```

### `spectrum_palette_ppx` package

| Generated HTML | Source |
|---|---|
| `spectrum_palette_ppx/index.html` | [doc/spectrum_palette_ppx/index.mld](../doc/spectrum_palette_ppx/index.mld) |
| `spectrum_palette_ppx/Spectrum_palette_ppx/index.html` | [lib/spectrum_palette_ppx/spectrum_palette_ppx.ml](../lib/spectrum_palette_ppx/spectrum_palette_ppx.ml) — wrapper module |
| `spectrum_palette_ppx/Spectrum_palette_ppx/Palette/index.html` | [lib/spectrum_palette_ppx/palette.mli](../lib/spectrum_palette_ppx/palette.mli) |
| `spectrum_palette_ppx/Spectrum_palette_ppx/Private/{Expander,Loader,Utils}/index.html` | `.ml` files in [lib/spectrum_palette_ppx/](../lib/spectrum_palette_ppx/) — no `.mli`, docs from `.ml` |

Dune config: [doc/spectrum_palette_ppx/dune](../doc/spectrum_palette_ppx/dune)

## Where documentation stanzas live

Each package has **two** `(documentation ...)` stanzas:

1. **`doc/<package>/dune`** — declares the hand-written `.mld` page(s) for that package
2. **`lib/<library>/dune`** — a bare `(documentation (package <name>))` stanza that associates the library's module docs with its package

The root `spectrum` package is slightly different: its `.mld` files live directly in `doc/dune` (not a subdirectory) because the dune-project names the main package `spectrum`.

## Adding new documentation pages

1. Create a new `.mld` file in the appropriate `doc/` subdirectory
2. Add the filename (without extension) to the `(mld_files ...)` list in the corresponding `doc/.../dune`
3. Link to it from other pages using `{!page-<filename>}`
4. Run `make docs` to verify

## odoc markup reference

The `.mld` files use odoc's markup language. Key syntax:

- `{0 Title}` — page title (level 0 heading, used once per page)
- `{1 Heading}` / `{2 Subheading}` — section headings
- `{!Module.path}` — cross-reference to a module or value
- `{!page-name}` — cross-reference to another `.mld` page
- `{{:https://...} link text}` — external link
- `{[code block]}` — code block
- `{t ... }` — table (odoc 3.x)
- `{%%html: ... %%}` — raw HTML escape

Full reference: https://ocaml.github.io/odoc/odoc_for_authors.html
